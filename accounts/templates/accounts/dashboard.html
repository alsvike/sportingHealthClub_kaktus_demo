{% extends 'accounts/base.html' %}

{% block title %}Oversigt{% endblock %}

{% block content %}
  <h1>Dashboard</h1>
  <p>Dette dashboard viser en oversigt over tilmeldte prøver og konverteringsmålinger.</p>

  <div class="card" style="margin-top:12px;max-width:620px">
  <h3 style="margin-bottom:8px">Oversigt over prøvetimer (eksempeldata)</h3>
    <div class="chart-wrap" style="width:100%;max-width:720px;">
      <!-- Tabs for months -->
      <div id="monthTabs" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
        <button data-month="0" class="month-tab btn" style="background:transparent;border:1px solid #e6eef6;padding:6px 8px;border-radius:6px;cursor:pointer">Jan</button>
        <button data-month="1" class="month-tab btn" style="background:transparent;border:1px solid #e6eef6;padding:6px 8px;border-radius:6px;cursor:pointer">Feb</button>
        <button data-month="2" class="month-tab btn" style="background:transparent;border:1px solid #e6eef6;padding:6px 8px;border-radius:6px;cursor:pointer">Mar</button>
        <button data-month="3" class="month-tab btn" style="background:transparent;border:1px solid #e6eef6;padding:6px 8px;border-radius:6px;cursor:pointer">Apr</button>
        <button data-month="4" class="month-tab btn" style="background:transparent;border:1px solid #e6eef6;padding:6px 8px;border-radius:6px;cursor:pointer">Maj</button>
        <button data-month="5" class="month-tab btn" style="background:transparent;border:1px solid #e6eef6;padding:6px 8px;border-radius:6px;cursor:pointer">Jun</button>
        <button data-month="6" class="month-tab btn" style="background:transparent;border:1px solid #e6eef6;padding:6px 8px;border-radius:6px;cursor:pointer">Jul</button>
        <button data-month="7" class="month-tab btn" style="background:transparent;border:1px solid #e6eef6;padding:6px 8px;border-radius:6px;cursor:pointer">Aug</button>
        <button data-month="8" class="month-tab btn" style="background:transparent;border:1px solid #e6eef6;padding:6px 8px;border-radius:6px;cursor:pointer">Sep</button>
        <button data-month="9" class="month-tab btn" style="background:transparent;border:1px solid #e6eef6;padding:6px 8px;border-radius:6px;cursor:pointer">Okt</button>
        <button data-month="10" class="month-tab btn" style="background:transparent;border:1px solid #e6eef6;padding:6px 8px;border-radius:6px;cursor:pointer">Nov</button>
        <button data-month="11" class="month-tab btn" style="background:transparent;border:1px solid #e6eef6;padding:6px 8px;border-radius:6px;cursor:pointer">Dec</button>
      </div>

      <!-- Panels: one canvas per month. Height controlled per panel. -->
        <div class="month-panel" data-month-panel="0" style="display:none;padding:6px;background:#fff;border-radius:6px;">
          <div style="width:100%;height:260px;"><canvas id="trialsChart-0" style="width:100%;height:100%"></canvas></div>
          <div class="month-empty" style="display:none;color:#6b7280;margin-top:8px">Ingen data for denne måned.</div>
        </div>
        <div class="month-panel" data-month-panel="1" style="display:none;padding:6px;background:#fff;border-radius:6px;">
          <div style="width:100%;height:260px;"><canvas id="trialsChart-1" style="width:100%;height:100%"></canvas></div>
          <div class="month-empty" style="display:none;color:#6b7280;margin-top:8px">Ingen data for denne måned.</div>
        </div>
        <div class="month-panel" data-month-panel="2" style="display:none;padding:6px;background:#fff;border-radius:6px;">
          <div style="width:100%;height:260px;"><canvas id="trialsChart-2" style="width:100%;height:100%"></canvas></div>
          <div class="month-empty" style="display:none;color:#6b7280;margin-top:8px">Ingen data for denne måned.</div>
        </div>
        <div class="month-panel" data-month-panel="3" style="display:none;padding:6px;background:#fff;border-radius:6px;">
          <div style="width:100%;height:260px;"><canvas id="trialsChart-3" style="width:100%;height:100%"></canvas></div>
          <div class="month-empty" style="display:none;color:#6b7280;margin-top:8px">Ingen data for denne måned.</div>
        </div>
        <div class="month-panel" data-month-panel="4" style="display:none;padding:6px;background:#fff;border-radius:6px;">
          <div style="width:100%;height:260px;"><canvas id="trialsChart-4" style="width:100%;height:100%"></canvas></div>
          <div class="month-empty" style="display:none;color:#6b7280;margin-top:8px">Ingen data for denne måned.</div>
        </div>
        <div class="month-panel" data-month-panel="5" style="display:none;padding:6px;background:#fff;border-radius:6px;">
          <div style="width:100%;height:260px;"><canvas id="trialsChart-5" style="width:100%;height:100%"></canvas></div>
          <div class="month-empty" style="display:none;color:#6b7280;margin-top:8px">Ingen data for denne måned.</div>
        </div>
        <div class="month-panel" data-month-panel="6" style="display:none;padding:6px;background:#fff;border-radius:6px;">
          <div style="width:100%;height:260px;"><canvas id="trialsChart-6" style="width:100%;height:100%"></canvas></div>
          <div class="month-empty" style="display:none;color:#6b7280;margin-top:8px">Ingen data for denne måned.</div>
        </div>
        <div class="month-panel" data-month-panel="7" style="display:none;padding:6px;background:#fff;border-radius:6px;">
          <div style="width:100%;height:260px;"><canvas id="trialsChart-7" style="width:100%;height:100%"></canvas></div>
          <div class="month-empty" style="display:none;color:#6b7280;margin-top:8px">Ingen data for denne måned.</div>
        </div>
        <div class="month-panel" data-month-panel="8" style="display:none;padding:6px;background:#fff;border-radius:6px;">
          <div style="width:100%;height:260px;"><canvas id="trialsChart-8" style="width:100%;height:100%"></canvas></div>
          <div class="month-empty" style="display:none;color:#6b7280;margin-top:8px">Ingen data for denne måned.</div>
        </div>
        <div class="month-panel" data-month-panel="9" style="display:none;padding:6px;background:#fff;border-radius:6px;">
          <div style="width:100%;height:260px;"><canvas id="trialsChart-9" style="width:100%;height:100%"></canvas></div>
          <div class="month-empty" style="display:none;color:#6b7280;margin-top:8px">Ingen data for denne måned.</div>
        </div>
        <div class="month-panel" data-month-panel="10" style="display:none;padding:6px;background:#fff;border-radius:6px;">
          <div style="width:100%;height:260px;"><canvas id="trialsChart-10" style="width:100%;height:100%"></canvas></div>
          <div class="month-empty" style="display:none;color:#6b7280;margin-top:8px">Ingen data for denne måned.</div>
        </div>
        <div class="month-panel" data-month-panel="11" style="display:none;padding:6px;background:#fff;border-radius:6px;">
          <div style="width:100%;height:260px;"><canvas id="trialsChart-11" style="width:100%;height:100%"></canvas></div>
          <div class="month-empty" style="display:none;color:#6b7280;margin-top:8px">Ingen data for denne måned.</div>
        </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:18px;font-size:0.95rem;color:var(--text-dark)">
      <div><strong>I alt registreret:</strong> {{ registered_sum }}</div>
      <div><strong>I alt konverteret:</strong> {{ converted_sum }}</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    (function(){
      const labels = {{ chart_labels|safe }} || [];
      const converted = {{ converted|safe }} || [];
      const notConverted = {{ not_converted|safe }} || [];

      // compute registered per-label as sum of converted + notConverted
      const registered = labels.map((_,i)=>((converted[i]||0) + (notConverted[i]||0)));

      // group data by month index (0-11) based on parsing labels as dates
      const months = Array.from({length:12}, ()=>({labels:[], converted:[], notConverted:[], registered:[]}));
      labels.forEach((lab,i)=>{
        let monthIndex = null;
        try{
          const dt = Date.parse(lab);
          if(!isNaN(dt)){
            monthIndex = new Date(dt).getMonth();
          }
        }catch(e){ monthIndex = null; }
        // fallback: if label not parseable, push into month 0
        if(monthIndex === null) monthIndex = 0;
        months[monthIndex].labels.push(lab);
        months[monthIndex].converted.push(converted[i] || 0);
        months[monthIndex].notConverted.push(notConverted[i] || 0);
        months[monthIndex].registered.push(registered[i] || 0);
      });

      // helper to create chart for given month index
      function createMonthChart(monthIdx){
        const panel = document.querySelector(`.month-panel[data-month-panel="${monthIdx}"]`);
        if(!panel) return;
        const canvas = document.getElementById(`trialsChart-${monthIdx}`);
        const mts = months[monthIdx];
        if(!mts.labels.length){
          panel.querySelector('.month-empty').style.display = 'block';
          canvas.style.display = 'none';
          return;
        }
        panel.querySelector('.month-empty').style.display = 'none';
        canvas.style.display = '';
        const ctx = canvas.getContext('2d');
        // destroy existing chart instance if present
        if(canvas._chartInstance){ try{ canvas._chartInstance.destroy(); }catch(e){} }
        const chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: mts.labels,
            datasets: [
              { label: 'Registreret', data: mts.registered, backgroundColor: 'rgba(156,163,175,0.9)', borderRadius:4, stack:'registered' },
              { label: 'Ikke konverteret', data: mts.notConverted, backgroundColor: 'rgba(239,68,68,0.95)', borderRadius:4, stack:'parts' },
              { label: 'Konverteret', data: mts.converted, backgroundColor: 'rgba(34,197,94,0.95)', borderRadius:4, stack:'parts' }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top', labels: {boxWidth:12, padding:8, font:{size:12}}}},
            scales: { x: { stacked:true, grid:{display:false}, ticks:{maxRotation:0, autoSkip:true, maxTicksLimit:7} }, y: { stacked:true, beginAtZero:true, grid:{color:'rgba(15,23,36,0.04)'}, ticks:{stepSize:5} } },
            elements: { point:{radius:0} }
          }
        });
        canvas._chartInstance = chart;
      }

      // init tabs
      const tabs = Array.from(document.querySelectorAll('#monthTabs .month-tab'));
      const panels = Array.from(document.querySelectorAll('.month-panel'));
      function setActiveMonth(idx){
        tabs.forEach(t=> t.style.background='transparent');
        panels.forEach(p=> p.style.display='none');
        const activeTab = tabs.find(t=>Number(t.dataset.month)===idx);
        if(activeTab) activeTab.style.background='#ffedd5';
        const panel = document.querySelector(`.month-panel[data-month-panel="${idx}"]`);
        if(panel) { panel.style.display='block'; createMonthChart(idx); }
      }

      tabs.forEach(t=> t.addEventListener('click', ()=> setActiveMonth(Number(t.dataset.month))));
      // default to current month if possible
      const now = new Date();
      const defaultMonth = (now && typeof now.getMonth === 'function') ? now.getMonth() : 0;
      setActiveMonth(defaultMonth);
    })();
  </script>

  {# User info removed from main dashboard content per design - sidebar shows signed-in info #}

{% endblock %}
